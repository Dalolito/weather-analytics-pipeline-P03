#!/usr/bin/env python3
"""
Script para verificar credenciales y configuraci√≥n de RDS
"""
import boto3
import mysql.connector
import os
from dotenv import load_dotenv
import json

load_dotenv()

def check_environment_variables():
    """Verificar variables de entorno de la base de datos"""
    print("üîç VERIFICANDO VARIABLES DE ENTORNO")
    print("="*50)
    
    db_vars = {
        'DB_HOST': os.getenv('DB_HOST'),
        'DB_USER': os.getenv('DB_USER'),
        'DB_PASSWORD': os.getenv('DB_PASSWORD'),
        'DB_NAME': os.getenv('DB_NAME'),
        'DB_PORT': os.getenv('DB_PORT', '3306')
    }
    
    print("üìã Variables configuradas:")
    for var, value in db_vars.items():
        if value:
            if 'PASSWORD' in var:
                # Mostrar solo primeros y √∫ltimos caracteres de la contrase√±a
                masked = value[:3] + '*' * (len(value) - 6) + value[-3:] if len(value) > 6 else '*' * len(value)
                print(f"‚úÖ {var}: {masked}")
            else:
                print(f"‚úÖ {var}: {value}")
        else:
            print(f"‚ùå {var}: NO CONFIGURADA")
    
    missing_vars = [var for var, value in db_vars.items() if not value]
    
    if missing_vars:
        print(f"\n‚ùå Variables faltantes: {missing_vars}")
        return False, db_vars
    else:
        print("\n‚úÖ Todas las variables est√°n configuradas")
        return True, db_vars

def get_rds_info_from_aws():
    """Obtener informaci√≥n real de RDS desde AWS"""
    print("\nüîç VERIFICANDO INFORMACI√ìN DE RDS EN AWS")
    print("="*50)
    
    try:
        rds_client = boto3.client('rds', region_name=os.getenv('AWS_DEFAULT_REGION', 'us-east-1'))
        
        # Extraer el nombre de la instancia desde el host
        db_host = os.getenv('DB_HOST')
        if not db_host:
            print("‚ùå DB_HOST no configurado")
            return None
        
        db_instance_id = db_host.split('.')[0]
        print(f"üéØ Buscando instancia: {db_instance_id}")
        
        response = rds_client.describe_db_instances(DBInstanceIdentifier=db_instance_id)
        instance = response['DBInstances'][0]
        
        rds_info = {
            'DBInstanceIdentifier': instance['DBInstanceIdentifier'],
            'DBInstanceStatus': instance['DBInstanceStatus'],
            'Engine': instance['Engine'],
            'EngineVersion': instance['EngineVersion'],
            'DBName': instance.get('DBName', 'N/A'),
            'MasterUsername': instance['MasterUsername'],
            'Endpoint': instance['Endpoint']['Address'],
            'Port': instance['Endpoint']['Port'],
            'PubliclyAccessible': instance['PubliclyAccessible'],
            'VpcId': instance.get('DBSubnetGroup', {}).get('VpcId', 'N/A'),
            'AvailabilityZone': instance['AvailabilityZone']
        }
        
        print("üìä Informaci√≥n de RDS:")
        for key, value in rds_info.items():
            icon = "‚úÖ" if key != 'DBInstanceStatus' or value == 'available' else "‚ö†Ô∏è"
            print(f"   {icon} {key}: {value}")
        
        return rds_info
        
    except Exception as e:
        print(f"‚ùå Error obteniendo informaci√≥n de RDS: {e}")
        return None

def compare_credentials(env_vars, rds_info):
    """Comparar credenciales del .env con la informaci√≥n real de RDS"""
    print("\nüîç COMPARANDO CREDENCIALES")
    print("="*50)
    
    issues = []
    
    # Verificar endpoint
    if env_vars['DB_HOST'] != rds_info['Endpoint']:
        issues.append(f"‚ùå Endpoint incorrecto: .env={env_vars['DB_HOST']}, RDS={rds_info['Endpoint']}")
    else:
        print(f"‚úÖ Endpoint correcto: {env_vars['DB_HOST']}")
    
    # Verificar puerto
    env_port = str(env_vars['DB_PORT'])
    rds_port = str(rds_info['Port'])
    if env_port != rds_port:
        issues.append(f"‚ùå Puerto incorrecto: .env={env_port}, RDS={rds_port}")
    else:
        print(f"‚úÖ Puerto correcto: {env_port}")
    
    # Verificar usuario maestro
    if env_vars['DB_USER'] != rds_info['MasterUsername']:
        issues.append(f"‚ùå Usuario incorrecto: .env={env_vars['DB_USER']}, RDS={rds_info['MasterUsername']}")
    else:
        print(f"‚úÖ Usuario correcto: {env_vars['DB_USER']}")
    
    # Verificar nombre de base de datos
    if rds_info['DBName'] != 'N/A' and env_vars['DB_NAME'] != rds_info['DBName']:
        issues.append(f"‚ö†Ô∏è Nombre de DB diferente: .env={env_vars['DB_NAME']}, RDS={rds_info['DBName']}")
    else:
        print(f"‚úÖ Nombre de DB: {env_vars['DB_NAME']}")
    
    # Verificar estado
    if rds_info['DBInstanceStatus'] != 'available':
        issues.append(f"‚ö†Ô∏è RDS no est√° disponible: Estado={rds_info['DBInstanceStatus']}")
    else:
        print(f"‚úÖ RDS disponible: {rds_info['DBInstanceStatus']}")
    
    return issues

def test_connection_step_by_step(db_config):
    """Probar conexi√≥n paso a paso con diferentes configuraciones"""
    print("\nüîå PROBANDO CONEXI√ìN PASO A PASO")
    print("="*50)
    
    # Test 1: Conexi√≥n b√°sica sin base de datos espec√≠fica
    print("üìù Test 1: Conexi√≥n sin especificar base de datos...")
    test_config = db_config.copy()
    test_config.pop('database', None)  # Remover database espec√≠fica
    
    try:
        conn = mysql.connector.connect(
            host=test_config['host'],
            user=test_config['user'],
            password=test_config['password'],
            port=int(test_config['port']),
            connect_timeout=10
        )
        print("‚úÖ Conexi√≥n b√°sica exitosa!")
        
        cursor = conn.cursor()
        cursor.execute("SELECT VERSION()")
        version = cursor.fetchone()
        print(f"   üìä Versi√≥n MySQL: {version[0]}")
        
        cursor.execute("SHOW DATABASES")
        databases = cursor.fetchall()
        print(f"   üìã Bases de datos disponibles:")
        for db in databases:
            print(f"      ‚Ä¢ {db[0]}")
        
        cursor.close()
        conn.close()
        
        return True, databases
        
    except mysql.connector.Error as e:
        print(f"‚ùå Error en conexi√≥n b√°sica: {e}")
        return False, []

def test_specific_database(db_config, available_databases):
    """Probar conexi√≥n a base de datos espec√≠fica"""
    print(f"\nüìù Test 2: Conexi√≥n a base de datos '{db_config['database']}'...")
    
    # Verificar si la base de datos existe
    db_exists = any(db[0] == db_config['database'] for db in available_databases)
    
    if not db_exists:
        print(f"‚ö†Ô∏è La base de datos '{db_config['database']}' no existe")
        print("üí° Bases de datos disponibles:")
        for db in available_databases:
            print(f"   ‚Ä¢ {db[0]}")
        
        # Intentar con una base de datos que existe
        if available_databases:
            test_db = available_databases[0][0]
            print(f"üîÑ Probando con '{test_db}' en su lugar...")
            
            test_config = db_config.copy()
            test_config['database'] = test_db
            
            try:
                conn = mysql.connector.connect(**test_config, connect_timeout=10)
                print(f"‚úÖ Conexi√≥n exitosa a '{test_db}'!")
                conn.close()
                return True
            except Exception as e:
                print(f"‚ùå Error conectando a '{test_db}': {e}")
                return False
    else:
        try:
            conn = mysql.connector.connect(**db_config, connect_timeout=10)
            print(f"‚úÖ Conexi√≥n exitosa a '{db_config['database']}'!")
            
            cursor = conn.cursor()
            cursor.execute("SHOW TABLES")
            tables = cursor.fetchall()
            print(f"   üìã Tablas en '{db_config['database']}':")
            if tables:
                for table in tables:
                    print(f"      ‚Ä¢ {table[0]}")
            else:
                print("      (No hay tablas)")
            
            cursor.close()
            conn.close()
            return True
            
        except mysql.connector.Error as e:
            print(f"‚ùå Error conectando a base de datos espec√≠fica: {e}")
            return False

def suggest_fixes(issues, env_vars, rds_info):
    """Sugerir correcciones basadas en los problemas encontrados"""
    print("\nüí° SUGERENCIAS DE CORRECCI√ìN")
    print("="*50)
    
    if not issues:
        print("üéâ ¬°No se encontraron problemas de configuraci√≥n!")
        return
    
    print("üìã Problemas encontrados y soluciones:")
    
    for issue in issues:
        print(f"\n{issue}")
        
        if "Endpoint incorrecto" in issue:
            print("üîß Soluci√≥n:")
            print(f"   Actualiza DB_HOST en tu .env a: {rds_info['Endpoint']}")
            
        elif "Puerto incorrecto" in issue:
            print("üîß Soluci√≥n:")
            print(f"   Actualiza DB_PORT en tu .env a: {rds_info['Port']}")
            
        elif "Usuario incorrecto" in issue:
            print("üîß Soluci√≥n:")
            print(f"   Actualiza DB_USER en tu .env a: {rds_info['MasterUsername']}")
            
        elif "no est√° disponible" in issue:
            print("üîß Soluci√≥n:")
            print("   Espera a que RDS est√© en estado 'available'")
            print("   Puede tomar varios minutos despu√©s de crear la instancia")
    
    # Generar archivo .env corregido
    print(f"\nüìù Archivo .env sugerido:")
    print("-" * 30)
    print(f"DB_HOST={rds_info['Endpoint']}")
    print(f"DB_USER={rds_info['MasterUsername']}")
    print(f"DB_PASSWORD={env_vars['DB_PASSWORD']}")
    print(f"DB_NAME={env_vars['DB_NAME']}")
    print(f"DB_PORT={rds_info['Port']}")

def main():
    """Funci√≥n principal"""
    print("üîê VERIFICACI√ìN COMPLETA DE CREDENCIALES RDS")
    print("="*60)
    
    # 1. Verificar variables de entorno
    vars_ok, env_vars = check_environment_variables()
    if not vars_ok:
        print("\n‚ùå Configura las variables faltantes en tu .env y vuelve a ejecutar")
        return False
    
    # 2. Obtener informaci√≥n real de RDS
    rds_info = get_rds_info_from_aws()
    if not rds_info:
        print("\n‚ùå No se pudo obtener informaci√≥n de RDS")
        return False
    
    # 3. Comparar credenciales
    issues = compare_credentials(env_vars, rds_info)
    
    # 4. Probar conexi√≥n paso a paso
    db_config = {
        'host': env_vars['DB_HOST'],
        'user': env_vars['DB_USER'],
        'password': env_vars['DB_PASSWORD'],
        'database': env_vars['DB_NAME'],
        'port': int(env_vars['DB_PORT'])
    }
    
    basic_conn_ok, available_dbs = test_connection_step_by_step(db_config)
    
    if basic_conn_ok:
        db_conn_ok = test_specific_database(db_config, available_dbs)
    else:
        db_conn_ok = False
    
    # 5. Sugerir correcciones
    suggest_fixes(issues, env_vars, rds_info)
    
    # Resumen final
    print("\n" + "="*60)
    print("üìä RESUMEN FINAL")
    print("="*60)
    
    print(f"üîß Variables de entorno: {'‚úÖ OK' if vars_ok else '‚ùå PROBLEMA'}")
    print(f"‚òÅÔ∏è Informaci√≥n de RDS: {'‚úÖ OK' if rds_info else '‚ùå PROBLEMA'}")
    print(f"üîå Conexi√≥n b√°sica: {'‚úÖ OK' if basic_conn_ok else '‚ùå PROBLEMA'}")
    print(f"üóÑÔ∏è Conexi√≥n a BD espec√≠fica: {'‚úÖ OK' if db_conn_ok else '‚ùå PROBLEMA'}")
    
    if basic_conn_ok and db_conn_ok:
        print("\nüéâ ¬°TODAS LAS CREDENCIALES EST√ÅN CORRECTAS!")
        print("üí° Tu conexi√≥n a RDS deber√≠a funcionar perfectamente")
    elif basic_conn_ok:
        print("\n‚ö†Ô∏è Conexi√≥n b√°sica funciona, pero hay problema con la base de datos espec√≠fica")
        print("üí° Verifica el nombre de la base de datos en DB_NAME")
    else:
        print("\n‚ùå Hay problemas con las credenciales o configuraci√≥n")
        print("üí° Revisa las sugerencias de correcci√≥n arriba")
    
    return basic_conn_ok and db_conn_ok

if __name__ == "__main__":
    main()